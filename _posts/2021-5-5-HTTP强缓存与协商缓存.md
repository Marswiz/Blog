---
layout: post
title: HTTP强缓存与协商缓存
date: 2021-5-5
categories: blog
tags: [http]
author: Mars
pIdentifier: 中文缩进
---

> HTTP缓存： 强缓存与协商缓存

# 一、HTTP缓存

## 1. 强缓存

浏览器执行请求时，如果发现本地有之前请求的缓存，先查看请求缓存中的首部行，判断是否命中强缓存：

> Cache-Control 和 Expires 均未过期， 则命中强缓存。
> 
> Cache-Control: 使用max-age=xxxs形式，相对值。绝对过期时间等于缓存请求时间+max-age值。（当二者同时存在，Cache-Control优先级更高。）
>
> Expires： 是GMT格式字符串（绝对值），意味着何时过期。浏览器在进行比较的时候使用的是系统时间，系统时间可以修改不可靠。  

这时，直接从缓存中读取响应（包含响应头），不与服务器通信。（状态码200）

## 2. 协商缓存

如果发现 Cache-Control 或 Expires 二者之一有过期，则发送请求到服务器：

> 如果缓存首部存在**Etag**，则发送带**If-None-Match**的请求；（优先级更高）
> 
> 如果缓存首部存在**Last-Modified**，则发送带**If-Modified-Since**的请求。

> **ETag 与 Last-Modified 的区别？**
> 
> ETag是服务器根据资源内容，自动生成的唯一的ID。它更能体现资源是否已修改。
> 
> Last-Modified主要是有以下三点问题： ① 最短修改时间只能精确到秒；② 有些文件在服务器周期性保存，内容并未修改，这时造成本地缓存的浪费；③ 某些服务器系统不能得到精确的修改时间。

由服务器根据这两个字段判断，缓存是否还可以使用。

如果可以，则意味着协商缓存命中，服务器返回新的响应header信息，但是不带有响应主体。（意味着服务器仍可从缓存中读取响应）（校验码304）

如果校验失败，服务器返回带响应主体的响应报文。（校验码200）

## 3. 用户行为对缓存的影响

按F5会忽略强缓存，保留协商缓存。

按Ctrl+F5会忽视全部缓存。

## 4. 如何保证每次资源更新浏览器都会及时更新，防止从缓存读取？

为每一个更新的资源，配置一个独有的资源名。

常用的是在资源后面加上query ID后缀。
